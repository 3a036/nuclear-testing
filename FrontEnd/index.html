<!doctype html>
<html>
<head>
    <style type="text/css">
        #container{
            position: fixed;
            left: 0px;
            right: 0px;
            top: 0px;
            bottom: 0px;
            background-color: grey;
            width: 100%;
            height: 100%;
            /*border-style:solid;
            border-width: 1px;
            border-color: black;*/
        }

        #slider{
            position: fixed;
            top:90%;
            left:1%;
            right: 0;
            bottom: 0;
            width: 98%;
            height: 7%;
            background-color: white;
            opacity: 0.6;
            z-index: 3;
        }
        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            cursor: crosshair;
            stroke-linecap: round;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }
    </style>
    <script src="http://d3js.org/d3.v3.min.js"> </script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
</head>
<body>
    <div id='container'>
        <div id='slider'></div>
    </div>
    
</body>
<script type="text/javascript">
    // Generate the world map from topojson file
    const FIRST_YEAR = 1945;
    const LAST_YEAR = 2006;
    const NUM_YEARS = LAST_YEAR - FIRST_YEAR;
    const NUM_DAYS = 22630;
    const SCREEN_WIDTH = window.innerWidth;
    const MARGIN = SCREEN_WIDTH/100;
    const TIMEBAR_WIDTH = d3.select('#slider').node().clientWidth - 60;
    const PATH_TO_MAP = './data/worldMap.json';
    let container = d3.select("#container");
    let width = container.node().clientWidth;
    let height = container.node().clientHeight;
    let nuclear_events;

    let svg = container.append('svg')
        .attr('width', width)
        .attr('height', height);

    // projection of the world map
    var projection = d3.geo.mercator().scale(width / 2 / Math.PI).translate([width/2, height/2+140]);

    d3.json(PATH_TO_MAP, function(error, topology) {
    if (error) throw error;

    var geojson = topojson.feature(topology, topology.objects.countries);

    svg.selectAll("path")
        .data(geojson.features)
        .enter().append("path")
        .attr("d", d3.geo.path().projection(projection));
    });


    // This function displays all the events on the map
    function display_events(rows){
        return svg.selectAll(".site").data(rows).enter()
            .append("circle")
            .attr("cx", function(row){return projection([row.lng, row.lat])[0];})
            .attr("cy", function(row){return projection([row.lng, row.lat])[1];})
            .attr('r', 5)
            .style('fill', 'red');
    }


    // Loading the data
    d3.tsv("./data/nuclear_test.tsv")
    .row(function(d) {
      return {
        magnitude: parseFloat(d.magnitude),
        country: d.country,
        name: d.name,
        site: d.site,
        textual_location: d.textual_infos,
        type: d.type,
        lat: parseFloat(d.lat),
        lng: parseFloat(d.lng),
        date: d.date
      };
    })
    .get(function(err, rows) {
        if (err) return console.error(err);
        nuclear_events = display_events(rows);
        nuclear_events.append("title").text(function (d) {return d.textual_location;});
        window.site_data = rows;
    });

    // Time slider

    var viewSlider = d3.select("#slider")
        .append("svg")
        .attr('width', SCREEN_WIDTH - MARGIN*2)
        .attr('height', 50);
        //.attr("transform", "translate(" + MARGIN/5 + "," + MARGIN/5+ ")");

        //Print time evolution top left corner
        /*var timeDisplay = viewSlider.append("text").attr("id", "timedisplay").attr("x", 110).attr("y", 220)
        .attr("visibility", "visible").attr("class", "city");*/

        //-------------Time slider-----------------
        //viewSlider.append("text").text("Time Line").attr("class", "city").attr("x", 50).attr("y", 130);

        var timeRange = d3.scale.linear()
            .domain([0, NUM_DAYS])
            .range([0, TIMEBAR_WIDTH])
            .clamp(true);

        var timeSlider = viewSlider.append("g")
            .attr('width', TIMEBAR_WIDTH)
            .attr("transform", "translate(" + 30 + "," + 20 + ")");

        timeSlider.append("line")
            .attr("class", "track")
            .attr("x1", timeRange.range()[0])
            .attr("x2", timeRange.range()[1])
            /*.select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-inset")
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-overlay")*/
            .call(d3.behavior.drag()
            .on("drag", function() {timeUpdate(timeRange.invert(d3.event.x)); }));

        /*timeSlider.insert("g", ".track-overlay")
            .attr("class", "ticks")
            .attr("transform", "translate(0," + 18 + ")")
            .selectAll("text")
            .data([0,60,120,180,240,300,360,420,480,540,600,660,720,780,840,900,960,1020,1080,1140,1200,1260,1320,1380,1440])
            .enter().append("text")
            .attr("x", timeRange)
            .attr("text-anchor", "middle")
            .text(function(d) { return d/60 + "h"; });*/

        let ticks = [];
        for(let i = 0; i < NUM_YEARS; i+=5){
            ticks.push(i*365);
        }
        console.log(ticks);

        timeSlider.insert('g', '.track-overlay')
            .attr('class', 'ticks')
            .attr('transform', 'translate(0,' + 20 + ')')
            .selectAll('text')
            .data(ticks)
            .enter().append('text')
            .attr('x', d => timeRange(d))
            .attr("text-anchor", "middle")
            .text(d => FIRST_YEAR +  (d/365));

        var timeHandle = timeSlider.insert("circle", ".track-overlay")
            .attr("class", "handle")
            .attr("cx", 12)
            .attr("r", 9)
            .call(d3.behavior.drag()
            .on("drag", function() {timeUpdate(timeRange.invert(d3.event.x)); }));


        function timeUpdate(a) {
            timeHandle.attr("cx", timeRange(a));
            m = Math.round(2*timeRange(a))%60;
            h = (2*timeRange(a) - 2*timeRange(a)%60) /60;
            currMoment = 60*h + m;
            if(currMoment < 464){
                d3.select("#auxiliaryNightRect").attr("visibility", "hidden");
            }
        }


</script>
</html>
