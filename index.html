<!doctype html>
<html>
<head>
    <style type="text/css">
        body {
            font-family: helvetica;
            color: #222;
        }

        a {
            font-weight: normal;
            /*color: white;*/
        }
        #container{
            position: fixed;
            left: 0px;
            right: 0px;
            top: 0px;
            bottom: 0px;
            width: 100%;
            height: 100%;
        }

        #month{
            width: 30px;
            display: inline-block;
        }

        #slider{
            position: fixed;
            top:94%;
            left:6%;
            right: 0;
            bottom: 0;
            width: 93%;
            height: 60px;
            background-color: white;
            opacity: 0.6;
            z-index: 3;
            border-radius: 10px;
        }
        
        #histogram{
            position: fixed;
            top:74%;
            left:6%;
            right: 0;
            bottom: 0;
            width: 93%;
            height: 300px;
            opacity: 0.6;
            z-index: 3;
        }
        
        #svg-button {
            width: 100%;
            height: 100%;
        }
        
        .play-button {
          position: fixed;
          top:94%;
          left:1%;
          right: 0;
          bottom: 0;
          width: 5%;
          height: 60px;
          background-color: white;
          border-radius: 10px;
          opacity: 0.6;
          z-index: 3;
          cursor: pointer;
        }

        #dateContainer{
            position: fixed;
            left: 5px;
            top: 5px;
            width: 7%;
            height:50px;
            background-color: white;
            opacity: 0.6;
            border-radius: 10px;
            text-align:center;
            line-height: 50px;
            display:block;
        }
        #checkboxContainer{
            position: fixed;
            left: 5px;
            top: 60px;
            height:50px;
            text-align:left;
            line-height: 50px;
            display:block;
        }

        .timeline {
            stroke: grey;
            stroke-linecap: round;
            stroke-width: 10px;
        }

        .event{
            opacity: 1;
            stroke: white;
            stroke-width: 1px;
        }

        .context {
            padding: 0.5em;
            max-width: 500px;
            min-width: 0;
            border-radius: 10px;
            /*font-size: 140%;*/
            font-weight: lighter;
            background-color: rgba(235, 235, 235, 0.8);
        }
        .context .leftarrow {
            color: rgba(235, 235, 235, 0.8);
            font-size: 150%;
            position: absolute;
            top: -30px;
            left: -30px;
        }
        
        .context .rightarrow {
            color: rgba(235, 235, 235, 0.8);
            font-size: 150%;
            position: absolute;
            top: -30px;
            right: -30px;
        }
        
        .context p {
            margin-top: 0;
        }

        #ranking{
            position: fixed;
            left: 5px;
        }

        .ranks{
            position: fixed;
            margin-bottom: 200px;
            display: table;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;

        }
        .rankspan{
            display:table-cell;
            vertical-align: middle;
            padding-left: 10px;
            font-size: 20px;
        }

        img{
            width: 30px;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"> </script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
</head>
<body>
    <div id='container'>
        <div id='dateContainer'>
            <span id='month'></span>
            <span id='year'></span>
        </div>
        <div id='checkboxContainer'>
            <button type='button' id='historyButton' onclick='handleClick(this);'>Show history</button>
        </div>
        <div id='ranking'></div>
        <button class="button play-button">
            <svg viewBox="0 0 36 36" id="svg-button" >
                <defs>
                    <path id="pause-icon" data-state="playing" d="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26" />
                    <path id="play-icon"  data-state="paused"  d="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28" />
                </defs>
                <use xlink:href="#play-icon" />
            </svg>
        </button>
        <div id='histogram'></div>
        <div id='slider'></div>
    </div>
    
</body>
<script type="text/javascript">
    // Generate the world map from topojson file
    const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun","Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const START_DATE = new Date("1945-01-01");
    const END_DATE = new Date("2020-12-31");
    const SCREEN_WIDTH = window.innerWidth;
    const MARGIN = SCREEN_WIDTH/100;
    const TIMEBAR_WIDTH = d3.select('#slider').node().clientWidth - 60;
    const PATH_TO_MAP = './data/worldMap.json';
    const INACTIVE_BAR_COLOR = 'white';
    const ACTIVE_BAR_COLOR = 'red';
    const COUNTRY_NAMES = {'GBR':'United Kingdom','USA':'United States of America', 'CHN':'China','FRA':'France','IND':'India','NK':'North Korea','PAK':'Pakistan','SOV':'Sovietic Union','UNK':'Unknown'};
    const MAP_COLOR = '#707779';//'#9DA3A4';
    const BACKGROUND_COLOR = '#121E21'//'#4B4B51';
    const SLOW_SPEED = 1;
    
    let contextsShown = 0;
    let step_size = 10; // represents the speed of the slider
    let last_speed = step_size;
    let animation_time = 3000 / (step_size)
    let was_running = false;
    let container = d3.select("#container");
    let width = container.node().clientWidth;
    let height = container.node().clientHeight;
    let current_date = START_DATE;
    let timer;
    let histHeight = height/5;
    let bins;
    let allCountries = [];
    let history = false;
    let click = false;
    

    container.style('background-color', BACKGROUND_COLOR);

    let svg = container.append('svg')
        .attr('width', width)
        .attr('height', height);
    
    let defs = svg.append('defs');
    
    // projection of the world map
    var projection = d3.geoMercator()
      .scale(width / 2 / Math.PI)
      .center([0,-5])
      .translate([width / 2, height / 2 + 140]);
    
    d3.json(PATH_TO_MAP, function(error, topology) {
        if (error) throw error;

        var geojson = topojson.feature(topology, topology.objects.countries);

        svg.selectAll("path")
            .data(geojson.features)
            .enter().append("path")
            .style('fill', MAP_COLOR)
            .attr("d", d3.geoPath().projection(projection));
    });
    
    // Time slider
    var viewHistogram = d3.select("#histogram")
        .append("svg")
        .attr('width', SCREEN_WIDTH - MARGIN*2)
        .attr('height', 500)
        .attr("transform", function(d) {
            return "translate(" + 20 + "," + 0 + ")";
          });
        
    var x = d3.scaleTime()
        .domain([START_DATE, END_DATE])
        .range([0, TIMEBAR_WIDTH])
        .clamp(true);

    // y scale for histogram
    var y = d3.scaleLinear()
        .range([histHeight, 0]);
    
    // set parameters for histogram
    var histogram = d3.histogram()
        .value(function(d) { return d.date; })
        .domain(x.domain())
        .thresholds(x.ticks(d3.timeYear));
        
    var hist = viewHistogram.append("g")
        .attr("class", "histogram");
    
    // Create binned data + images for display on map
    d3.tsv("./data/nuclear_test.tsv", prepare, function(data) {
    // group data for bars
      bins = histogram(data);
      
      // y domain based on binned data
      y.domain([0, d3.max(bins, function(d) { return d.length; })]);
      
      data.forEach(function(d, i) {
            if (d3.select("#"+d.country).empty()){
                allCountries.push(d.country);
                defs.append("pattern")
                    .attr("id", d.country)
                    .attr("height","100%")
                    .attr("width", "100%")
                    .attr("patternContentUnits", "objectBoundingBox")
                    .append("image")
                    .attr("height","1")
                    .attr("width","1")
                    .attr("preserveAspectRatio","none")
                    .attr("xlink:href","./data/"+d.country+".png");  
            }
      });

      var bar = hist.selectAll('.bar')
        .data(bins)
        .enter()
        .append("g")
        .attr("class", "bar")
        .attr("transform", function(d) {
            return "translate(" + x(d.x0) + "," + y(d.length) + ")";
        });
            
        bar.append("rect")
            .attr("class", "bar")
            .attr("x", 1)
            .attr("width", function(d) {return x(d.x1) - x(d.x0) - 5 ; })
            .attr("height", function(d) {return histHeight - y(d.length);}) 
            .attr("fill", INACTIVE_BAR_COLOR)
            .attr("rx", 3)
            .attr("ry", 3);

    }); 

    // Loading the data
    d3.tsv("./data/nuclear_test.tsv")
    .row(function(d) {
      var datesplit = d.date.split('/');
      return {
        id: d.id,
        magnitude: parseInt(d.magnitude),
        country: d.country,
        name: d.name,
        site: d.site,
        textual_location: d.textual_infos,
        type: d.type,
        x: projection([d.lng, d.lat])[0],
        y: projection([d.lng, d.lat])[1],
        date: new Date(parseInt(datesplit[2]), parseInt(datesplit[1])-1, parseInt(datesplit[0]))
      };
    })
    .get(function(err, rows) {
        if (err) return console.error(err);
        window.site_data = rows;
        initRanking();
    });
    
    // Loading contextual data
    d3.tsv("./data/nuclear_test_context.tsv")
    .row(function(d) {
      return {
        id: d.id,
        description: d.description,
        url: d.url
      };
    })
    .get(function(err, rows) {
        if (err) return console.error(err);
        window.contextual_data = rows;
    });

    // Time slider
    var viewSlider = d3.select("#slider")
        .append("svg")
        .attr('width', SCREEN_WIDTH - MARGIN*2)
        .attr('height', 50); 
       
    var timeSlider = viewSlider.append("g")
        .attr('id', 'timebar')
        .attr('width', TIMEBAR_WIDTH)
        .attr("transform", "translate(" + 30 + "," + 20 + ")");

    timeSlider.append("line")
        .on("click", function(){
            timeHandle.attr('cx', d3.mouse(this)[0]);
            previous_date = new Date(current_date);
            current_date = x.invert(d3.mouse(this)[0]);
            updatebars(previous_date, current_date);
            removeShownCircles();
            removeAllContext();
            
            previous_date = new Date(current_date);
            previous_date = new Date(previous_date.setMonth(previous_date.getMonth()-12));
            click = true;
            update(previous_date, current_date);
            history = false;
        })
        .attr("class", "timeline")
        .attr("x1", x.range()[0])
        .attr("x2", x.range()[1]);

    let ticks = [];
    for(let i = 0; i < diff_years(END_DATE,START_DATE); i+=5){
        ticks.push(new Date(START_DATE.getFullYear() + i, 1, 0));
    }
    
    timeSlider.insert('g')
        .attr('class', 'ticks')
        .attr('transform', 'translate(0,' + 25 + ')')
        .selectAll('text')
        .data(ticks)
        .enter().append('text')
        .attr('x', d => x(d))
        .attr("text-anchor", "middle")
        .text(d => d.getFullYear());

    var timeHandle = timeSlider.insert("circle")
        .attr("class", "handle")
        .attr("cx", 0)
        .attr("r", 10)
        .call(d3.drag()
        .on('start', function(){
            was_running = pauseAnimation();
            removeShownCircles();
        })
        .on("drag", function(){
            onSlideEvent(x.invert(d3.event.x));
        })
        .on("end", function(){
            if(was_running) playAnimation();
        }));

    // Returns, if any, contextual information for a given event
    function getContext(event) {
        context = window.contextual_data.filter(context => context.id == event.id);
        if(context) {
            return context[0];
        }
    }

    // print the input date in the date container
    function printDate(date){
        d3.select('#month').html(MONTH_NAMES[date.getMonth()]);
        d3.select('#year').html(date.getFullYear());
    }

    // prints a marker on the map at the location of the input event
    function printEvent(event){
        svg.append("circle")
            .attr("class", "event")
            .attr("cx", event.x)
            .attr("cy", event.y)
            .attr("fill", "url(#"+event.country+")")
            .attr("r", 0)
            .transition()
            .duration(animation_time)
            .attr("r", Math.exp(event.magnitude * 2/3))
            .transition()
            .duration(animation_time)
            .attr("r", 0)
            .remove();
    }
    
    // prints a marker on the map at the location of the input event
    function printClickEvent(event){
        svg.append("circle")
            .attr("class", "event")
            .attr("cx", event.x)
            .attr("cy", event.y)
            .attr("fill", "url(#"+event.country+")")
            .attr("r", 0)
            .transition()
            .duration(animation_time)
            .attr("r", Math.exp(event.magnitude * 2/3));
    }
    
    // prints instant marker on the map for the history
    function printInstantEvent(event){
        svg.append("circle")
                .attr("class", "event")
                .attr("cx", event.x)
                .attr("cy", event.y)
                .attr("fill", "url(#"+event.country+")")
                .attr("r", Math.exp(event.magnitude * 2/3))
                .style("opacity", 0.5);
    }

    function printContext(event, context) {
        let contextSpan = $('<span class="context" id="'+event.id+'">');
        contextSpan.html('<p>' + context.description + '</p> <a href="' + context.url + '">' +
            context.url + '</a>');
        contextSpan.css({
            position: "absolute",
            display: "none",
        });

        let space = 45;
        if(event.x < width/2) {
            contextSpan.css({
                left: event.x+45,
                top: event.y+45,
            });
            contextSpan.append('<span class="leftarrow">&#8598;</span>');
        } else {
            contextSpan.css({
                right: width-event.x+45,
                top: event.y+45,
            });
            contextSpan.append('<span class="rightarrow">&#8599;</span>');
        }
        $('#container').append(contextSpan);
        contextSpan.fadeIn(animation_time);
    }

    // Remove context info
    function removeContext(event) {
        $('#'+event.id).fadeOut(animation_time/10, () => $('#'+event.id).remove());
    }
    
    // Remove context info
    function removeAllContext(event) {
        $('.context').fadeOut(animation_time, () => $('.context').remove());
    }

    //This function is called when the slider is moved manually
    //input: The date (START_DATE to END_DATE) corresponding to the slider position
    function onSlideEvent(date) {
        let previous_date = current_date;
        current_date = date;
        update(previous_date, current_date);
        updatebars(previous_date, current_date);
    }
    
    // Continue the transition of current shown circles
    function removeShownCircles() {
        d3.selectAll(".event")
        .transition()
        .duration(animation_time)
        .style('r',0)
        .remove();
    }

    // Instant remove of current shown circles
    function removeInstantShownCircles() {
        d3.selectAll(".event")
        .remove();
    }

    // called at each tick of the timer
    function step(stepSize){
        printDate(current_date);
        let previous_date = current_date;
        current_date = d3.timeDay.offset(current_date, stepSize);
        if(current_date>=END_DATE){
            current_date = START_DATE;
            pauseAnimation();
            playButton.goToNextState();
        }
        update(previous_date, current_date);
        updatebars(previous_date, current_date);
    }
    
    // Update visualization in function of two dates
    function update(previous_date, current_date){
        printDate(current_date);
        timeHandle.attr("cx", x(current_date));
        window.site_data.filter(event => (event.date <= current_date && event.date > previous_date)).forEach(event => {
            context = getContext(event);
            if(context) {
                contextsShown+=1;
                printContext(event, context);
                if(step_size!=SLOW_SPEED){
                    last_speed = step_size;
                }
                changeSpeed(SLOW_SPEED);
                if (!click){
                    setTimeout(function(){
                        if (timer){
                            removeContext(event);
                        }
                    }, 1.9 * animation_time);
                    setTimeout(function(){
                        if (contextsShown==1){
                            changeSpeed(last_speed);
                            removeShownCircles();
                        }
                        contextsShown-=1;
                    }, 2*animation_time);
                }
            }
            if(click){
                printClickEvent(event);
            } else {
                printEvent(event);
            }
        }); 

        let ranking = getRanking(current_date);
        printRanking(ranking);
        click = false;
    }
    
    // Change speed 
    function changeSpeed(speed){
        step_size = speed;
        animation_time = 3000 / step_size
    }
    
    // Update histogram colors in function of two dates
    function updatebars(previous_date, current_date){
        d3.selectAll(".bar").filter(d => (d.x0 <= current_date && d.x0 > previous_date))
            .attr("fill", INACTIVE_BAR_COLOR).transition().duration(500)
            .attr("fill", ACTIVE_BAR_COLOR);
        
        d3.selectAll(".bar").filter(d => (d.x0 > current_date && d.x0 <= previous_date))
            .attr("fill", ACTIVE_BAR_COLOR).transition().duration(500)
            .attr("fill", INACTIVE_BAR_COLOR);
    }

    function playAnimation(){
        if(!timer) timer = setInterval(function(d){step(step_size)}, 10);
        was_running = true;
        history = false;
        removeShownCircles();
        removeAllContext();
        changeSpeed(last_speed);
    }

    function pauseAnimation(){
        let previous_state = timer;
        if(timer){
            clearInterval(timer);
            timer = false;
        }
        history = false;
        return previous_state;
    }
    
    // Prepare the data for histogram
    function prepare(d) {
      var datesplit = d.date.split('/')
      d.date = new Date(parseInt(datesplit[2]), parseInt(datesplit[1])-1, parseInt(datesplit[0]));
      return d;
    }
    
    // Return the number of years between 2 dates
    function diff_years(dt2, dt1){
        var diff =(dt2.getTime() - dt1.getTime()) / 1000;
        diff /= (60 * 60 * 24);
        return Math.abs(Math.round(diff/365.25));
    }
    
    // Function that handle button click
    function handleClick(button) {
        if(!history){
            window.site_data.filter(event => (event.date <= current_date)).forEach(event => printInstantEvent(event));
            if(timer){
                pauseAnimation();
                playButton.goToNextState();
            }
        }
        history = true;
    }

    // returns the number of explosions per country up to the date given
    function getRanking(date){
        let n_tests_per_country = {};
        allCountries.forEach(c => n_tests_per_country[c] = 0);
        window.site_data.filter(event => (event.date <= current_date)).map(e => e.country).forEach(c => n_tests_per_country[c] += 1);
        // return an array because an object's order cannot be guaranted
        let ranking = [];
        Object.keys(n_tests_per_country).forEach(key => ranking.push([key, n_tests_per_country[key]]));
        ranking.sort(function(a, b){
            return b[1] - a[1];
        });
        return ranking;
    }

    function initRanking(){
        let ranks = d3.select('#ranking').selectAll('.ranks').data(allCountries);

        ranks.enter()
            .append('div')
            .attr('class', 'ranks')
            .html(x => "<img src=./data/" + x + ".png alt='"+ x + "' title='" + COUNTRY_NAMES[x] + "'> <span class='rankspan'>0</span>")
            .style('top', function(d, i) {
                return 270 + ((i*50)) + "px";
            });
    }

    function printRanking(ranking){
        let ranks = d3.select('#ranking').selectAll('.ranks').data(ranking);

        ranks.html(x => "<img src=./data/" + x[0] + ".png alt='"+ x + "' title='" + COUNTRY_NAMES[x[0]] + "'> <span class='rankspan'>" + x[1] + "</span>")
            //.sort(function(a, b) {return d3.ascending(b[1], a[1]);})
            .transition()
            .style('top', function(d, i) {
                return 270 + ((i*50)) + "px";
            });
    }
    
    
    // PlayPause button inspired from : http://bl.ocks.org/guilhermesimoes/fbe967d45ceeb350b765
    var playButton = {
        el: document.querySelector(".play-button"),
        states: {
            playing: {
                nextState: "paused",
                iconEl: document.querySelector("#pause-icon")
            },
            paused:  {
                nextState: "playing",
                iconEl: document.querySelector("#play-icon")
            }
        },
        animationDuration: 350,
        init: function () {
            this.setInitialState();
            this.replaceUseEl();
            this.el.addEventListener("click", this.goToNextState.bind(this));
        },
        setInitialState: function () {
          var initialIconRef = this.el.querySelector("use").getAttribute("xlink:href");
          var stateName = this.el.querySelector(initialIconRef).getAttribute("data-state");
          this.setState(stateName);
        },
        replaceUseEl: function () {
            d3.select(this.el.querySelector("use")).remove();
            d3.select(this.el.querySelector("svg")).append("path")
                .attr("class", "js-icon")
                .attr("d", this.stateIconPath());
        },
        goToNextState: function () {
            if (this.state.nextState == "paused") {
              pauseAnimation();
              d3.selectAll(".event").transition().duration(animation_time);
              // timer = 0;
            } else {
              // timer that moves the slider automatically
              playAnimation();
              changeSpeed(last_speed);
            }
            this.setState(this.state.nextState);
            d3.select(this.el.querySelector(".js-icon")).transition()
                .duration(this.animationDuration)
                .attr("d", this.stateIconPath());
        },
        setState: function (stateName) {
            this.state = this.states[stateName];
        },
        stateIconPath: function () {
            return this.state.iconEl.getAttribute("d");
        }
    };
    playButton.init();
    
</script>
</html>
